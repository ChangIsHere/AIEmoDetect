"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/request.js"),o=require("../../common/assets.js"),i=e.defineComponent({data:()=>({step:1,isRecordingVideo:!1,countdownValue:15,countdownProgress:100,countdownInterval:null,cameraContext:null,hasPermissions:!1,tempVideoPath:"",emotionData:null}),onReady(){this.cameraContext=e.index.createCameraContext()},methods:{goBack(){e.index.navigateBack()},handleCameraError(t=null){console.error("相机错误:",t),e.index.showToast({title:"相机初始化失败，请检查权限",icon:"none",duration:2e3})},requestPermissions(){e.index.showLoading({title:"请求权限中..."}),e.index.authorize(new UTSJSONObject({scope:"scope.record",success:()=>{e.index.authorize(new UTSJSONObject({scope:"scope.camera",success:()=>{this.hasPermissions=!0,e.index.hideLoading(),e.index.showToast({title:"授权成功",icon:"success",duration:1500}),setTimeout((()=>{this.step=2}),1500)},fail:()=>{this.handlePermissionFailure()}}))},fail:()=>{this.handlePermissionFailure()}}))},handlePermissionFailure(){e.index.hideLoading(),e.index.showModal(new UTSJSONObject({title:"权限请求",content:"需要麦克风和摄像头权限才能进行情绪分析。请在设置中开启相关权限。",confirmText:"去设置",success:t=>{t.confirm&&e.index.openSetting()}}))},startCountdown(e=null){this.countdownValue=15,this.countdownProgress=100,this.countdownInterval&&clearInterval(this.countdownInterval),this.countdownInterval=setInterval((()=>{this.countdownValue--,this.countdownProgress=this.countdownValue/15*100,this.countdownValue<=0&&(clearInterval(this.countdownInterval),e())}),1e3)},startVideoRecording(){if(!this.cameraContext)return e.index.showToast({title:"相机初始化失败",icon:"none"}),null;this.isRecordingVideo=!0,this.tempVideoPath="",this.startCountdown((()=>{this.stopVideoRecording()})),this.cameraContext.startRecord(new UTSJSONObject({duration:15,compressed:!0,success:(e=null)=>{console.log("视频录制完成:",e.tempFilePath),this.tempVideoPath=e.tempFilePath},fail:(t=null)=>{console.error("视频录制失败:",t),e.index.showToast({title:"视频录制失败",icon:"none"}),this.isRecordingVideo=!1}})),this.cameraContext.onStop(((e=null)=>{console.log("相机录制已停止",e),this.isRecordingVideo=!1,e.tempFilePath&&(this.tempVideoPath=e.tempFilePath)}))},stopVideoRecording(){clearInterval(this.countdownInterval),this.cameraContext&&this.cameraContext.stopRecord()},discardVideo(){this.tempVideoPath="",this.isRecordingVideo=!1,this.countdownValue=15,this.countdownProgress=100,e.index.showToast({title:"已取消录制",icon:"none"})},submitVideo(){return e.__awaiter(this,void 0,void 0,(function*(){if(!this.tempVideoPath)return e.index.showToast({title:"请先录制视频",icon:"none"}),Promise.resolve(null);this.step=3,e.index.showLoading({title:"视频分析中...",mask:!0});try{const o=yield t.request.analyzeEmotionFromVideo(new UTSJSONObject({filePath:this.tempVideoPath}));e.index.hideLoading(),console.log("视频分析结果:",o),this.emotionData=o,e.index.showToast({title:"分析完成",icon:"success"}),setTimeout((()=>{this.goToResultPage()}),1e3)}catch(o){e.index.hideLoading(),console.error("视频上传或分析失败:",o),e.index.showToast({title:"视频分析失败，请重试",icon:"none",duration:3e3}),this.step=2}}))},goToResultPage(){this.emotionData?e.index.redirectTo({url:"/pages/emotion-result/emotion-result?data="+encodeURIComponent(UTS.JSON.stringify(this.emotionData))}):(e.index.showToast({title:"未获取到分析数据",icon:"none"}),this.step=2)}}});const s=e._export_sfc(i,[["render",function(t,i,s,n,d,r){return e.e({a:e.o(((...e)=>r.goBack&&r.goBack(...e))),b:d.step>=1?1:"",c:d.step>1?1:"",d:d.step>=2?1:"",e:d.step>2?1:"",f:d.step>=3?1:"",g:d.step>3?1:"",h:1===d.step},1===d.step?{i:o._imports_0$2,j:e.o(((...e)=>r.requestPermissions&&r.requestPermissions(...e)))}:{},{k:2===d.step},2===d.step?e.e({l:!d.isRecordingVideo&&d.tempVideoPath},!d.isRecordingVideo&&d.tempVideoPath?{m:e.sei("videoCapture","video"),n:d.tempVideoPath}:d.tempVideoPath?{}:{p:e.o(((...e)=>r.handleCameraError&&r.handleCameraError(...e)))},{o:!d.tempVideoPath,q:d.isRecordingVideo},(d.isRecordingVideo,{}),{r:e.t(d.isRecordingVideo?"正在录制中，请对着镜头讲述您的问题或情绪...":d.tempVideoPath?"视频已录制完成，您可以预览或重新录制":"点击下方按钮开始录制"),s:d.isRecordingVideo},d.isRecordingVideo?{t:e.t(d.countdownValue),v:d.countdownProgress+"%"}:{},{w:!d.isRecordingVideo&&!d.tempVideoPath},d.isRecordingVideo||d.tempVideoPath?{}:{x:e.o(((...e)=>r.startVideoRecording&&r.startVideoRecording(...e)))},{y:!d.isRecordingVideo&&d.tempVideoPath},!d.isRecordingVideo&&d.tempVideoPath?{z:e.o(((...e)=>r.discardVideo&&r.discardVideo(...e))),A:e.o(((...e)=>r.submitVideo&&r.submitVideo(...e)))}:{}):{},{B:3===d.step},(d.step,{}),{C:e.sei(e.gei(t,""),"view")})}]]);wx.createPage(s);
