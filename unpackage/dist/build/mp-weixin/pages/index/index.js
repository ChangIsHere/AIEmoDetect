"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/request.js"),t=["难受","心情不好","自杀","焦虑","恐慌","抑郁","不想活","压力大","很累","绝望","无助","烦躁","痛苦","崩溃","想哭","不开心","伤心","失眠","没意义","想放弃","没人懂","孤独","害怕","恐惧","烦","累","不想说话","不想动","不想见人","不想上班","不想上学","没动力","没希望","想死","想离开","烦闷","心累","心痛","绝望","麻木","无感","无聊","无助","无望","不想活了","撑不住","撑不下去","情绪低落","消沉","郁闷","闷闷不乐","萎靡不振","沮丧","悲伤","哀伤","愁苦","失落","灰心","失望","愤懑","恼怒","火大","暴躁","狂躁","怨恨","厌恶","憎恨","反感","不满","气愤","紧张","担忧","忧虑","不安","手足无措","心烦意乱","忐忑","惊恐","骇然","毛骨悚然","不寒而栗","寂寞","孤单","空虚","失落","无聊","空虚","迷茫","彷徨","困惑","疲惫","精疲力尽","身心俱疲","筋疲力尽","虚弱","乏力","力不从心","透支","厌世","生无可恋","了无生趣","苟延残喘","行尸走肉","自我否定","自我怀疑","无地自容","羞愧","内疚","逃避","躲避","退缩","不敢面对","不敢想","不想提","忘不掉","放不下","走不出来"];let n=null;const i=e.defineComponent({data:()=>({messages:[],userInput:"",keyboardHeight:0,animating:!1,scrollTop:0,loading:!1,messageCount:0,showEmotionModal:!1,sessionId:"user_"+Date.now(),lastShowPromptTime:0,isLandscape:!1,windowWidth:0,windowHeight:0}),onLoad(){console.log("页面 onLoad: 初始化屏幕尺寸和监听器");const o=e.index.getSystemInfoSync();this.windowWidth=o.windowWidth,this.windowHeight=o.windowHeight,this.checkOrientation(),window.addEventListener("resize",this.handleResize)},onUnload(){console.log("页面 onUnload: 移除屏幕尺寸监听器"),window.removeEventListener("resize",this.handleResize),n&&clearTimeout(n)},methods:{checkOrientation(){const e=this.windowWidth>this.windowHeight;this.isLandscape!==e&&(this.isLandscape=e,console.log("屏幕方向切换到: "+(e?"横屏模式":"竖屏模式")))},handleResize(){console.log("窗口尺寸变化事件触发"),clearTimeout(n),n=setTimeout((()=>{const o=e.index.getSystemInfoSync();this.windowWidth=o.windowWidth,this.windowHeight=o.windowHeight,console.log(`新窗口尺寸: 宽度=${this.windowWidth}, 高度=${this.windowHeight}`),this.checkOrientation()}),100)},containsNegativeKeyword:(e=null)=>t.some((o=>e.includes(o))),containsAIRecommendedKeyword(e=null){let o=["情绪扫描","情绪分析","检测你的情绪","心理检测","情绪波动","情绪状态","心情如何","心理状况","需要帮助","看起来很","建议你","似乎你在","或许你需要","我感受到你的","看起来你可能在","你的语气显示","让我们一起"].some((o=>e.includes(o))),t=["伤心","难过","焦虑","担忧","生气","愤怒","恐惧","紧张","压力","困扰","烦恼","消极","抑郁","悲观"].filter((o=>e.includes(o))).length;return o||t>=2},runComprehensiveEmotionCheck(){var o,t;if(this.messageCount<3)return null;if(Date.now()-this.lastShowPromptTime<3e5)return null;let n=!1;try{for(var i=e.__values(this.messages),s=i.next();!s.done;s=i.next()){var l=s.value;if("user"===l.type){if(this.containsNegativeKeyword(l.content)){n=!0;break}}else if("ai"===l.type&&this.containsAIRecommendedKeyword(l.content)){n=!0;break}}}catch(a){o={error:a}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}n&&!this.showEmotionModal&&setTimeout((()=>{this.showEmotionModal=!0,this.lastShowPromptTime=Date.now()}),1e3)},handleSend(){if(!this.userInput.trim()||this.animating||this.loading)return null;const e=this.userInput.trim();this.userInput="",this.animating=!0,this.loading=!0,this.messages.push({content:e,type:"user",id:Date.now()}),this.$nextTick((()=>{this.scrollToBottom(),this.getAIResponse(e),this.messageCount++,this.runComprehensiveEmotionCheck()}))},getAIResponse(t=null){console.log("getAIResponse: 开始调用LLM API"),console.log("发送给LLM的userText:",t),console.log("使用的sessionId:",this.sessionId),e.index.showLoading({title:"分析中...",mask:!1}),o.request.chatWithLLM(new UTSJSONObject({message:t,sessionId:this.sessionId})).then(((o=null)=>{console.log("LLM API调用成功，收到完整响应:",o),e.index.hideLoading();const t=o.response_text;t?(this.messages.push({content:t,type:"ai",id:Date.now()}),console.log("LLM响应内容:",t),this.runComprehensiveEmotionCheck()):(console.warn("LLM响应中未找到response_text或其为空:",o),e.index.showToast({title:"AI响应内容为空",icon:"none",duration:2e3}))})).catch(((o=null)=>{console.error("LLM API调用失败，捕获到错误:",o),e.index.hideLoading(),console.error("LLM请求失败的完整错误信息:",UTS.JSON.stringify(o,null,2));let t="AI服务暂时不可用";o&&(o.message&&(t=o.message),o.detail&&("string"==typeof o.detail?t+=`: ${o.detail}`:o.detail.errMsg?t+=`: ${o.detail.errMsg}`:Array.isArray(o.detail)&&o.detail.length>0&&o.detail[0].msg&&(t+=`: ${o.detail[0].msg}`))),e.index.showToast({title:t,icon:"none",duration:4e3})})).finally((()=>{console.log("LLM API调用结束，执行 finally 块"),this.$nextTick((()=>{this.scrollToBottom(),this.loading=!1,setTimeout((()=>{this.animating=!1}),300)}))}))},handleInputClick(){},scrollToBottom(){setTimeout((()=>{e.index.createSelectorQuery().in(this).selectAll(".chat-box view").boundingClientRect(((e=null)=>{e&&e.length>0&&(this.scrollTop=1e4)})).exec()}),100)},closeEmotionModal(){this.showEmotionModal=!1},startEmotionDetection(){this.closeEmotionModal(),e.index.navigateTo({url:"/pages/emotion-detect/emotion-detect"})},onSettingTap(){e.index.showToast({title:"设置功能开发中...",icon:"none"})}}});const s=e._export_sfc(i,[["render",function(o,t,n,i,s,l){return e.e({a:e.f(20,((e,o,t)=>({a:e}))),b:e.f(s.messages,((o,t,n)=>({a:e.t(o.content),b:o.id,c:e.n("user"===o.type?"user-message":"ai-message")}))),c:s.loading},(s.loading,{}),{d:s.scrollTop,e:e.o(((...e)=>l.handleInputClick&&l.handleInputClick(...e))),f:e.o(((...e)=>l.handleSend&&l.handleSend(...e))),g:s.loading,h:s.userInput,i:e.o((e=>s.userInput=e.detail.value)),j:e.o(((...e)=>l.handleSend&&l.handleSend(...e))),k:s.loading?1:"",l:s.showEmotionModal},s.showEmotionModal?{m:e.o(((...e)=>l.closeEmotionModal&&l.closeEmotionModal(...e))),n:e.o(((...e)=>l.closeEmotionModal&&l.closeEmotionModal(...e))),o:e.o(((...e)=>l.startEmotionDetection&&l.startEmotionDetection(...e))),p:e.o((()=>{}))}:{},{q:e.o(((...e)=>l.onSettingTap&&l.onSettingTap(...e))),r:e.sei(e.gei(o,""),"view")})}],["__scopeId","data-v-f42121d3"]]);wx.createPage(s);
