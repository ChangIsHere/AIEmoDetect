{"code":"import { defineComponent } from \"vue\";\nimport request from '../../utils/request.js';\nexport default defineComponent({\n    data() {\n        return {\n            step: 1,\n            isRecordingVideo: false,\n            countdownValue: 15,\n            countdownProgress: 100,\n            countdownInterval: null,\n            cameraContext: null,\n            hasPermissions: false,\n            tempVideoPath: '',\n            emotionData: null // 情绪分析数据\n        };\n    },\n    onReady() {\n        // 初始化相机上下文\n        this.cameraContext = uni.createCameraContext();\n    },\n    methods: {\n        // 返回上一页\n        goBack() {\n            uni.navigateBack();\n        },\n        // 处理相机错误\n        handleCameraError(err = null) {\n            uni.__f__('error', 'at pages/emotion-detect/emotion-detect.uvue:111', '相机错误:', err);\n            uni.showToast({\n                title: '相机初始化失败，请检查权限',\n                icon: 'none',\n                duration: 2000\n            });\n        },\n        // 请求麦克风和摄像头权限\n        requestPermissions() {\n            uni.showLoading({\n                title: '请求权限中...'\n            });\n            // 请求麦克风权限\n            uni.authorize(new UTSJSONObject({\n                scope: 'scope.record',\n                success: () => {\n                    // 请求摄像头权限\n                    uni.authorize(new UTSJSONObject({\n                        scope: 'scope.camera',\n                        success: () => {\n                            this.hasPermissions = true;\n                            uni.hideLoading();\n                            uni.showToast({\n                                title: '授权成功',\n                                icon: 'success',\n                                duration: 1500\n                            });\n                            setTimeout(() => {\n                                this.step = 2;\n                            }, 1500);\n                        },\n                        fail: () => {\n                            this.handlePermissionFailure();\n                        }\n                    }));\n                },\n                fail: () => {\n                    this.handlePermissionFailure();\n                }\n            }));\n        },\n        // 处理权限请求失败\n        handlePermissionFailure() {\n            uni.hideLoading();\n            uni.showModal(new UTSJSONObject({\n                title: '权限请求',\n                content: '需要麦克风和摄像头权限才能进行情绪分析。请在设置中开启相关权限。',\n                confirmText: '去设置',\n                success: (res) => {\n                    if (res.confirm) {\n                        uni.openSetting();\n                    }\n                }\n            }));\n        },\n        // 开始倒计时\n        startCountdown(callback = null) {\n            this.countdownValue = 15;\n            this.countdownProgress = 100;\n            // 清除可能存在的旧倒计时\n            if (this.countdownInterval) {\n                clearInterval(this.countdownInterval);\n            }\n            this.countdownInterval = setInterval(() => {\n                this.countdownValue--;\n                this.countdownProgress = (this.countdownValue / 15) * 100;\n                if (this.countdownValue <= 0) {\n                    clearInterval(this.countdownInterval);\n                    callback();\n                }\n            }, 1000);\n        },\n        // 开始视频录制\n        startVideoRecording() {\n            if (!this.cameraContext) {\n                uni.showToast({ title: '相机初始化失败', icon: 'none' });\n                return null;\n            }\n            this.isRecordingVideo = true;\n            this.tempVideoPath = '';\n            this.startCountdown(() => {\n                this.stopVideoRecording();\n            });\n            this.cameraContext.startRecord(new UTSJSONObject({\n                duration: 15,\n                compressed: true,\n                success: (res = null) => {\n                    uni.__f__('log', 'at pages/emotion-detect/emotion-detect.uvue:209', '视频录制完成:', res.tempFilePath);\n                    this.tempVideoPath = res.tempFilePath;\n                },\n                fail: (err = null) => {\n                    uni.__f__('error', 'at pages/emotion-detect/emotion-detect.uvue:213', '视频录制失败:', err);\n                    uni.showToast({ title: '视频录制失败', icon: 'none' });\n                    this.isRecordingVideo = false; // 录制失败也停止状态\n                }\n            }));\n            // 监听录制停止事件（无论成功或失败）\n            this.cameraContext.onStop((res = null) => {\n                uni.__f__('log', 'at pages/emotion-detect/emotion-detect.uvue:221', '相机录制已停止', res);\n                this.isRecordingVideo = false;\n                if (res.tempFilePath) {\n                    this.tempVideoPath = res.tempFilePath;\n                }\n            });\n        },\n        // 停止视频录制\n        stopVideoRecording() {\n            clearInterval(this.countdownInterval);\n            if (this.cameraContext) {\n                this.cameraContext.stopRecord();\n            }\n        },\n        // 放弃视频，重置状态以便重新录制\n        discardVideo() {\n            this.tempVideoPath = '';\n            this.isRecordingVideo = false;\n            this.countdownValue = 15; // 重置倒计时\n            this.countdownProgress = 100; // 重置进度条\n            uni.showToast({ title: '已取消录制', icon: 'none' });\n        },\n        // 提交视频进行分析\n        submitVideo() {\n            if (!this.tempVideoPath) {\n                uni.showToast({ title: '请先录制视频', icon: 'none' });\n                return null;\n            }\n            this.step = 3; // 进入分析中步骤\n            uni.showLoading({\n                title: '视频分析中...',\n                mask: true\n            });\n            uni.uploadFile({\n                url: 'http://localhost:5000/analyze/video',\n                filePath: this.tempVideoPath,\n                name: 'video',\n                header: new UTSJSONObject({\n                    'Content-Type': 'multipart/form-data'\n                }),\n                success: (uploadFileRes) => {\n                    uni.hideLoading();\n                    const resData = UTS.JSON.parse(uploadFileRes.data);\n                    uni.__f__('log', 'at pages/emotion-detect/emotion-detect.uvue:269', '视频分析结果:', resData);\n                    this.emotionData = resData;\n                    uni.showToast({ title: '分析完成', icon: 'success' });\n                    // 跳转到结果页\n                    setTimeout(() => {\n                        this.goToResultPage();\n                    }, 1000);\n                },\n                fail: (err) => {\n                    uni.hideLoading();\n                    uni.__f__('error', 'at pages/emotion-detect/emotion-detect.uvue:279', '视频上传或分析失败:', err);\n                    uni.showToast({\n                        title: '视频分析失败，请重试',\n                        icon: 'none',\n                        duration: 3000\n                    });\n                    // 失败后回到视频录制步骤，允许重试\n                    this.step = 2;\n                }\n            });\n        },\n        // 跳转到结果页\n        goToResultPage() {\n            if (this.emotionData) {\n                uni.redirectTo({\n                    url: '/pages/emotion-result/emotion-result?data=' + encodeURIComponent(UTS.JSON.stringify(this.emotionData))\n                });\n            }\n            else {\n                uni.showToast({ title: '未获取到分析数据', icon: 'none' });\n                // 如果没有数据，回到初始或录制页面\n                this.step = 2;\n            }\n        }\n    }\n});\n//# sourceMappingURL=/Users/peggy/Documents/HBuilderProjects/AI%20EmoDetect/AIEmoDetect/pages/emotion-detect/emotion-detect.uvue?vue&type=script&lang.uts.js.map","references":["/Users/peggy/Documents/HBuilderProjects/AI EmoDetect/AIEmoDetect/utils/request.js"],"uniExtApis":["uni.createCameraContext","uni.navigateBack","uni.__f__","uni.showToast","uni.showLoading","uni.authorize","uni.hideLoading","uni.showModal","uni.openSetting","uni.uploadFile","uni.redirectTo"],"map":"{\"version\":3,\"file\":\"emotion-detect.uvue?vue&type=script&lang.uts.js\",\"sourceRoot\":\"\",\"sources\":[\"emotion-detect.uvue?vue&type=script&lang.uts\"],\"names\":[],\"mappings\":\";AACA,OAAO,OAAO,MAAM,wBAAwB,CAAA;AAE5C,+BAAe;IACd,IAAI;QACH,OAAO;YACN,IAAI,EAAE,CAAC;YACP,gBAAgB,EAAE,KAAK;YACvB,cAAc,EAAE,EAAE;YAClB,iBAAiB,EAAE,GAAG;YACtB,iBAAiB,EAAE,IAAI;YACvB,aAAa,EAAE,IAAI;YACnB,cAAc,EAAE,KAAK;YACrB,aAAa,EAAE,EAAE;YACjB,WAAW,EAAE,IAAI,CAAE,SAAS;SAC5B,CAAA;IACF,CAAC;IACD,OAAO;QACN,WAAW;QACX,IAAI,CAAC,aAAa,GAAG,GAAG,CAAC,mBAAmB,EAAE,CAAC;IAChD,CAAC;IACD,OAAO,EAAE;QACR,QAAQ;QACR,MAAM;YACL,GAAG,CAAC,YAAY,EAAE,CAAA;QACnB,CAAC;QAED,SAAS;QACT,iBAAiB,CAAC,GAAG,OAAA;YACpB,GAAG,CAAC,KAAK,CAAC,OAAO,EAAC,iDAAiD,EAAC,OAAO,EAAE,GAAG,CAAC,CAAA;YACjF,GAAG,CAAC,SAAS,CAAC;gBACb,KAAK,EAAE,eAAe;gBACtB,IAAI,EAAE,MAAM;gBACZ,QAAQ,EAAE,IAAI;aACd,CAAC,CAAA;QACH,CAAC;QAED,cAAc;QACd,kBAAkB;YACjB,GAAG,CAAC,WAAW,CAAC;gBACf,KAAK,EAAE,UAAU;aACjB,CAAC,CAAA;YAEF,UAAU;YACV,GAAG,CAAC,SAAS,mBAAC;gBACb,KAAK,EAAE,cAAc;gBACrB,OAAO,EAAE;oBACR,UAAU;oBACV,GAAG,CAAC,SAAS,mBAAC;wBACb,KAAK,EAAE,cAAc;wBACrB,OAAO,EAAE;4BACR,IAAI,CAAC,cAAc,GAAG,IAAI,CAAA;4BAC1B,GAAG,CAAC,WAAW,EAAE,CAAA;4BACjB,GAAG,CAAC,SAAS,CAAC;gCACb,KAAK,EAAE,MAAM;gCACb,IAAI,EAAE,SAAS;gCACf,QAAQ,EAAE,IAAI;6BACd,CAAC,CAAA;4BAEF,UAAU,CAAC;gCACV,IAAI,CAAC,IAAI,GAAG,CAAC,CAAA;4BACd,CAAC,EAAE,IAAI,CAAC,CAAA;wBACT,CAAC;wBACD,IAAI,EAAE;4BACL,IAAI,CAAC,uBAAuB,EAAE,CAAA;wBAC/B,CAAC;qBACD,EAAC,CAAA;gBACH,CAAC;gBACD,IAAI,EAAE;oBACL,IAAI,CAAC,uBAAuB,EAAE,CAAA;gBAC/B,CAAC;aACD,EAAC,CAAA;QACH,CAAC;QAED,WAAW;QACX,uBAAuB;YACtB,GAAG,CAAC,WAAW,EAAE,CAAA;YACjB,GAAG,CAAC,SAAS,mBAAC;gBACb,KAAK,EAAE,MAAM;gBACb,OAAO,EAAE,kCAAkC;gBAC3C,WAAW,EAAE,KAAK;gBAClB,OAAO,EAAE,CAAC,GAAG;oBACZ,IAAI,GAAG,CAAC,OAAO,EAAE;wBAChB,GAAG,CAAC,WAAW,EAAE,CAAA;qBACjB;gBACF,CAAC;aACD,EAAC,CAAA;QACH,CAAC;QAED,QAAQ;QACR,cAAc,CAAC,QAAQ,OAAA;YACtB,IAAI,CAAC,cAAc,GAAG,EAAE,CAAA;YACxB,IAAI,CAAC,iBAAiB,GAAG,GAAG,CAAA;YAE5B,cAAc;YACd,IAAI,IAAI,CAAC,iBAAiB,EAAE;gBAC3B,aAAa,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAA;aACrC;YAED,IAAI,CAAC,iBAAiB,GAAG,WAAW,CAAC;gBACpC,IAAI,CAAC,cAAc,EAAE,CAAA;gBACrB,IAAI,CAAC,iBAAiB,GAAG,CAAC,IAAI,CAAC,cAAc,GAAG,EAAE,CAAC,GAAG,GAAG,CAAA;gBAEzD,IAAI,IAAI,CAAC,cAAc,IAAI,CAAC,EAAE;oBAC7B,aAAa,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAA;oBACrC,QAAQ,EAAE,CAAA;iBACV;YACF,CAAC,EAAE,IAAI,CAAC,CAAA;QACT,CAAC;QAED,SAAS;QACT,mBAAmB;YAClB,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;gBACxB,GAAG,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAA;gBACjD,YAAM;aACN;YACD,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAA;YAC5B,IAAI,CAAC,aAAa,GAAG,EAAE,CAAA;YAEvB,IAAI,CAAC,cAAc,CAAC;gBACnB,IAAI,CAAC,kBAAkB,EAAE,CAAA;YAC1B,CAAC,CAAC,CAAA;YAEF,IAAI,CAAC,aAAa,CAAC,WAAW,mBAAC;gBAC9B,QAAQ,EAAE,EAAE;gBACZ,UAAU,EAAE,IAAI;gBAChB,OAAO,EAAE,CAAC,GAAG,OAAA;oBACZ,GAAG,CAAC,KAAK,CAAC,KAAK,EAAC,iDAAiD,EAAC,SAAS,EAAE,GAAG,CAAC,YAAY,CAAC,CAAA;oBAC9F,IAAI,CAAC,aAAa,GAAG,GAAG,CAAC,YAAY,CAAA;gBACtC,CAAC;gBACD,IAAI,EAAE,CAAC,GAAG,OAAA;oBACT,GAAG,CAAC,KAAK,CAAC,OAAO,EAAC,iDAAiD,EAAC,SAAS,EAAE,GAAG,CAAC,CAAA;oBACnF,GAAG,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAA;oBAChD,IAAI,CAAC,gBAAgB,GAAG,KAAK,CAAA,CAAC,YAAY;gBAC3C,CAAC;aACD,EAAC,CAAA;YAEF,oBAAoB;YACpB,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,GAAG,OAAA;gBAC7B,GAAG,CAAC,KAAK,CAAC,KAAK,EAAC,iDAAiD,EAAC,SAAS,EAAE,GAAG,CAAC,CAAA;gBACjF,IAAI,CAAC,gBAAgB,GAAG,KAAK,CAAA;gBAC7B,IAAI,GAAG,CAAC,YAAY,EAAE;oBACrB,IAAI,CAAC,aAAa,GAAG,GAAG,CAAC,YAAY,CAAA;iBACrC;YACF,CAAC,CAAC,CAAA;QACH,CAAC;QAED,SAAS;QACT,kBAAkB;YACjB,aAAa,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAA;YACrC,IAAI,IAAI,CAAC,aAAa,EAAE;gBACvB,IAAI,CAAC,aAAa,CAAC,UAAU,EAAE,CAAA;aAC/B;QACF,CAAC;QAED,kBAAkB;QAClB,YAAY;YACX,IAAI,CAAC,aAAa,GAAG,EAAE,CAAA;YACvB,IAAI,CAAC,gBAAgB,GAAG,KAAK,CAAA;YAC7B,IAAI,CAAC,cAAc,GAAG,EAAE,CAAA,CAAC,QAAQ;YACjC,IAAI,CAAC,iBAAiB,GAAG,GAAG,CAAA,CAAC,QAAQ;YACrC,GAAG,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAA;QAChD,CAAC;QAED,WAAW;QACX,WAAW;YACV,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;gBACxB,GAAG,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAA;gBAChD,YAAM;aACN;YAED,IAAI,CAAC,IAAI,GAAG,CAAC,CAAA,CAAC,UAAU;YACxB,GAAG,CAAC,WAAW,CAAC;gBACf,KAAK,EAAE,UAAU;gBACjB,IAAI,EAAE,IAAI;aACV,CAAC,CAAA;YAEF,GAAG,CAAC,UAAU,CAAC;gBACd,GAAG,EAAE,qCAAqC;gBAC1C,QAAQ,EAAE,IAAI,CAAC,aAAa;gBAC5B,IAAI,EAAE,OAAO;gBACb,MAAM,oBAAE;oBACP,cAAc,EAAE,qBAAqB;iBACrC,CAAA;gBACD,OAAO,EAAE,CAAC,aAAa;oBACtB,GAAG,CAAC,WAAW,EAAE,CAAA;oBACjB,MAAM,OAAO,GAAG,SAAK,KAAK,CAAC,aAAa,CAAC,IAAI,CAAC,CAAA;oBAC9C,GAAG,CAAC,KAAK,CAAC,KAAK,EAAC,iDAAiD,EAAC,SAAS,EAAE,OAAO,CAAC,CAAA;oBACrF,IAAI,CAAC,WAAW,GAAG,OAAO,CAAA;oBAC1B,GAAG,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC,CAAA;oBACjD,SAAS;oBACT,UAAU,CAAC;wBACV,IAAI,CAAC,cAAc,EAAE,CAAA;oBACtB,CAAC,EAAE,IAAI,CAAC,CAAA;gBACT,CAAC;gBACD,IAAI,EAAE,CAAC,GAAG;oBACT,GAAG,CAAC,WAAW,EAAE,CAAA;oBACjB,GAAG,CAAC,KAAK,CAAC,OAAO,EAAC,iDAAiD,EAAC,YAAY,EAAE,GAAG,CAAC,CAAA;oBACtF,GAAG,CAAC,SAAS,CAAC;wBACb,KAAK,EAAE,YAAY;wBACnB,IAAI,EAAE,MAAM;wBACZ,QAAQ,EAAE,IAAI;qBACd,CAAC,CAAA;oBACF,mBAAmB;oBACnB,IAAI,CAAC,IAAI,GAAG,CAAC,CAAA;gBACd,CAAC;aACD,CAAC,CAAA;QACH,CAAC;QAED,SAAS;QACT,cAAc;YACb,IAAI,IAAI,CAAC,WAAW,EAAE;gBACrB,GAAG,CAAC,UAAU,CAAC;oBACd,GAAG,EAAE,4CAA4C,GAAG,kBAAkB,CAAC,SAAK,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;iBACxG,CAAC,CAAA;aACF;iBAAM;gBACN,GAAG,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,UAAU,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAA;gBAClD,mBAAmB;gBACnB,IAAI,CAAC,IAAI,GAAG,CAAC,CAAA;aACb;QACF,CAAC;KACD;CACD,EAAA\"}"}
